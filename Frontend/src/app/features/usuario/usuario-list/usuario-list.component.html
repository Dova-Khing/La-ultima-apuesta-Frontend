<div class="container mt-4">
    <h2 class="mb-4">Gestión de Usuarios</h2>

    <!-- Mensaje de Alerta/Error (UI Message) -->
    <div *ngIf="uiMessage" class="alert alert-warning alert-dismissible fade show" role="alert">
        {{ uiMessage }}
        <button type="button" class="btn-close" (click)="uiMessage = null" aria-label="Close"></button>
    </div>

    <!-- Botón para Abrir Modal de Creación -->
    <button class="btn btn-primary mb-4 shadow-sm" (click)="openCreateModal()">
        <i class="fas fa-plus me-2"></i> Crear Nuevo Usuario
    </button>

    <!-- LISTA DE USUARIOS -->
    <div class="card p-3 shadow-sm">
        <h5>Usuarios Registrados</h5>

        <div class="table-responsive">
            <table class="table table-striped table-hover mt-3">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Usuario</th>
                        <th>Email</th>
                        <th>Edad</th>
                        <th>Teléfono</th>
                        <th>Activo</th>
                        <th>Admin</th>
                        <th>Saldo</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let usuario of usuarios">
                        <td>{{ usuario.id }}</td>
                        <td>{{ usuario.nombre }}</td>
                        <td>{{ usuario.nombre_usuario }}</td>
                        <td>{{ usuario.email }}</td>
                        <td>{{ usuario.edad }}</td>
                        <td>{{ usuario.telefono }}</td>
                        <td>
                            <span class="badge" [ngClass]="usuario.activo ? 'bg-success' : 'bg-danger'">
                                {{ usuario.activo ? 'Sí' : 'No' }}
                            </span>
                        </td>
                        <td>
                            <span class="badge" [ngClass]="usuario.es_admin ? 'bg-info' : 'bg-secondary'">
                                {{ usuario.es_admin ? 'Sí' : 'No' }}
                            </span>
                        </td>
                        <td>{{ usuario.saldo_inicial | currency:'USD':'symbol' }}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-warning me-2" (click)="editUsuario(usuario)" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" (click)="deleteUsuario(usuario)" title="Eliminar">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div *ngIf="!usuarios.length && !loading" class="text-center text-muted py-4">
            No hay usuarios registrados que coincidan con los filtros.
        </div>

        <!-- Paginación (Simulación - Aquí iría la lógica completa de paginación si se usaran los métodos goToPage) -->
        <nav *ngIf="totalPages > 1" class="d-flex justify-content-center mt-3">
            <ul class="pagination">
                <li class="page-item" [class.disabled]="currentPage === 1">
                    <a class="page-link" (click)="goToPage(currentPage - 1)">Anterior</a>
                </li>
                <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index"
                    [class.active]="currentPage === i + 1">
                    <a class="page-link" (click)="goToPage(i + 1)">{{ i + 1 }}</a>
                </li>
                <li class="page-item" [class.disabled]="currentPage === totalPages">
                    <a class="page-link" (click)="goToPage(currentPage + 1)">Siguiente</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- MODAL DE CREACIÓN/EDICIÓN - CORREGIDO -->
<!-- Se eliminó ngStyle y se usa solo la clase 'show' para el control básico -->
<div class="modal fade" [class.show]="showModal" [class.d-block]="showModal" tabindex="-1"
    [attr.aria-hidden]="!showModal" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    {{ editingUsuario ? 'Editar Usuario: ' + editingUsuario.nombre : 'Crear Nuevo Usuario' }}
                </h5>
                <button type="button" class="btn-close btn-close-white" (click)="closeModal()"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form #usuarioFormRef="ngForm" (ngSubmit)="saveUsuario()">
                    <div class="row g-3">

                        <!-- Nombre completo -->
                        <div class="col-md-6">
                            <label class="form-label">Nombre completo (*)</label>
                            <input class="form-control rounded-lg" type="text" [(ngModel)]="nuevoUsuario.nombre"
                                name="nombre" #nombre="ngModel" required>
                            <div *ngIf="nombre.invalid && (nombre.dirty || nombre.touched)" class="text-danger mt-1">
                                El nombre es obligatorio.
                            </div>
                        </div>

                        <!-- Nombre de usuario -->
                        <div class="col-md-6">
                            <label class="form-label">Nombre de usuario (*)</label>
                            <input class="form-control rounded-lg" type="text" [(ngModel)]="nuevoUsuario.nombre_usuario"
                                name="nombre_usuario" #nombre_usuario="ngModel" required>
                            <div *ngIf="nombre_usuario.invalid && (nombre_usuario.dirty || nombre_usuario.touched)"
                                class="text-danger mt-1">
                                El nombre de usuario es obligatorio.
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="col-md-6">
                            <label class="form-label">Correo electrónico (*)</label>
                            <input class="form-control rounded-lg" type="email" [(ngModel)]="nuevoUsuario.email"
                                name="email" #email="ngModel" required email>
                            <div *ngIf="email.invalid && (email.dirty || email.touched)" class="text-danger mt-1">
                                Ingrese un correo electrónico válido.
                            </div>
                        </div>

                        <!-- Teléfono -->
                        <div class="col-md-6">
                            <label class="form-label">Teléfono</label>
                            <input class="form-control rounded-lg" type="text" [(ngModel)]="nuevoUsuario.telefono"
                                name="telefono">
                        </div>

                        <!-- Edad -->
                        <div class="col-md-6">
                            <label class="form-label">Edad (*)</label>
                            <input class="form-control rounded-lg" type="number" min="19"
                                [(ngModel)]="nuevoUsuario.edad" name="edad" #edad="ngModel" required>
                            <div *ngIf="edad.invalid && (edad.dirty || edad.touched)" class="text-danger mt-1">
                                <!-- CORRECCIÓN: Usar notación de corchetes para acceder a las propiedades de error -->
                                <span *ngIf="edad.errors?.['required']">La edad es obligatoria.</span>
                                <span *ngIf="edad.errors?.['min']">La edad debe ser al menos 19 años.</span>
                            </div>
                        </div>

                        <!-- Contraseña (Requerida solo en creación o si se edita el campo) -->
                        <div class="col-md-6">
                            <label class="form-label">Contraseña (*)</label>
                            <!-- La contraseña solo es requerida si es un nuevo usuario, sino es opcional -->
                            <input class="form-control rounded-lg" type="password" [(ngModel)]="nuevoUsuario.contrasena"
                                name="contrasena" #contrasena="ngModel" [required]="!editingUsuario">
                            <div *ngIf="contrasena.invalid && (contrasena.dirty || contrasena.touched)"
                                class="text-danger mt-1">
                                <span *ngIf="contrasena.errors?.['required']">La contraseña es obligatoria.</span>
                            </div>
                        </div>

                        <!-- Saldo -->
                        <div class="col-md-6">
                            <label class="form-label">Saldo inicial</label>
                            <input class="form-control rounded-lg" type="number"
                                [(ngModel)]="nuevoUsuario.saldo_inicial" name="saldo_inicial">
                        </div>

                        <!-- Checkboxes -->
                        <div class="col-md-6 d-flex align-items-center pt-4">
                            <!-- Activo -->
                            <div class="form-check me-4">
                                <input class="form-check-input" type="checkbox" [(ngModel)]="nuevoUsuario.activo"
                                    name="activo">
                                <label class="form-check-label">Activo</label>
                            </div>
                            <!-- Admin -->
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" [(ngModel)]="nuevoUsuario.es_admin"
                                    name="es_admin">
                                <label class="form-check-label">Administrador</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary" (click)="saveUsuario()"
                    [disabled]="usuarioFormRef.invalid">
                    {{ editingUsuario ? 'Guardar Cambios' : 'Crear Usuario' }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- FONDO DEL MODAL (BACKDROP) - CORREGIDO -->
<!-- Se utiliza solo la clase 'modal-backdrop' para evitar conflictos de foco/accesibilidad -->
<div *ngIf="showModal" class="modal-backdrop fade show"></div>


<!-- MODAL DE CONFIRMACIÓN (para eliminar) - Mantenemos la estructura por si la quieres activar luego -->
<div class="modal fade" [class.show]="showConfirmModal" [class.d-block]="showConfirmModal"
    [attr.aria-hidden]="!showConfirmModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmación</h5>
                <button type="button" class="btn-close btn-close-white" (click)="cancelConfirmation()"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>{{ confirmMessage }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="cancelConfirmation()">No</button>
                <button type="button" class="btn btn-danger" (click)="executeConfirmation()">Sí, Eliminar</button>
            </div>
        </div>
    </div>
</div>

<!-- Fondo del Modal de Confirmación -->
<div *ngIf="showConfirmModal" class="modal-backdrop fade show"></div>
